# 修复日志 - 2025-08-10

## 修复的问题

### 1. 空工具调用问题
- **症状**：Agent 输出大量空的或不完整的工具调用
- **原因**：流式 API 在构建 JSON 时的每个中间状态都被输出
- **修复**：
  - 文件：`src/async_agent.py`
  - 改动：删除第 318 行和第 364 行的过早 yield
  - 结果：工具调用只在完成时输出一次

### 2. Shell 输出格式问题
- **症状**：Shell 输出包含命令回显、控制字符和提示符
- **原因**：输出处理没有充分清理这些系统元素
- **修复**：
  - 文件：`src/persistent_shell.py`
  - 改动：
    - 提前处理 `\r` 字符
    - 智能检测并移除命令回显
    - 检测并移除末尾的提示符
  - 结果：输出只包含实际的命令结果

## 改进效果

### 修复前
```
🔧 执行命令: 
🔧 执行命令: {"co
🔧 执行命令: {"command": "echo 'Hello'"
...
输出: echo 'Hello W \rorld'\nHello World\nuser@host:~$
```

### 修复后
```
🔧 执行命令: echo 'Hello World'
输出: Hello World
```

## 影响范围
- 所有使用流式 API 的场景
- 所有 Shell 命令执行
- 向后兼容，不影响现有功能

## 测试状态
✅ 单元测试通过
✅ 集成测试通过
✅ 代码格式检查通过

---

## 新增修复：错误堆栈显示

### 问题
- 错误时只显示简短信息，不利于开发调试

### 修复
1. **main.py**：主循环错误处理添加 `traceback.print_exc()`
2. **src/async_agent.py**：工具执行错误包含 `traceback.format_exc()`

### 效果
- 开发阶段可以看到完整的错误堆栈
- 快速定位问题源头
- 提升调试效率